<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Problems</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Edit Problems</h1>
            <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#createModal">
            âœ¨ Create New Problem
            </button>
        </div>
        <div id="problems-container" class="row">
            </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Problem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="edit-prompt-id">
                        <div class="mb-3">
                            <label for="edit-title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="edit-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-question-text" class="form-label">Question Text (Markdown supported)</label>
                            <textarea class="form-control" id="edit-question-text" rows="5" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-ai-prompt" class="form-label">AI Prompt (Instructions for Gemini)</label>
                            <textarea class="form-control" id="edit-ai-prompt" rows="8" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-image" class="form-label">Upload New Image (Optional)</label>
                            <input class="form-control" type="file" id="edit-image" accept="image/*">
                            <small class="form-text text-muted">If you upload a new image, it will replace the current one.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitUpdate()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Create a New Problem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-question-form">
                    <div class="mb-3">
                        <label for="create-title" class="form-label">Question Title:</label>
                        <input type="text" class="form-control" id="create-title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="create-question-text" class="form-label">Question Text (What students see):</label>
                        <textarea class="form-control" id="create-question-text" name="question_text" rows="5" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="create-ai-prompt" class="form-label">AI Grading Instructions (The rubric for the AI):</label>
                        <textarea class="form-control" id="create-ai-prompt" name="ai_prompt" rows="8" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="create-image" class="form-label">Image (Optional):</label>
                        <input class="form-control" type="file" id="create-image" name="image" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" form="create-question-form">Create Question</button>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let allProblems = []; // ç”¨æ¥å­˜å‚¨ä»APIè·å–çš„æ‰€æœ‰é—®é¢˜æ•°æ®

        document.addEventListener('DOMContentLoaded', function() {
            fetchProblems();
        });

        async function fetchProblems() {
            const response = await fetch('/api/get-all-questions');
            if (!response.ok) {
                console.error('Failed to fetch problems.');
                return;
            }
            allProblems = await response.json();
            const container = document.getElementById('problems-container');
            container.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

            if (allProblems.length === 0) {
                container.innerHTML = '<p>No problems found.</p>';
                return;
            }

            allProblems.forEach(problem => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-4';
                col.innerHTML = `
                    <div class="card h-100">
                        ${problem.image_url ? `<img src="${problem.image_url}" class="card-img-top" alt="Problem Image">` : ''}
                        <div class="card-body">
                            <h5 class="card-title">${problem.title}</h5>
                            <p class="card-text small text-muted">${problem.prompt_id}</p>
                        </div>
                        <div class="card-footer">
                           <button class="btn btn-primary" onclick="openEditModal('${problem.prompt_id}')">Edit</button>
                            <button class="btn btn-danger ms-2" onclick="deleteProblem('${problem.prompt_id}')">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function openEditModal(promptId) {
            const problem = allProblems.find(p => p.prompt_id === promptId);
            if (!problem) return;

            // å¡«å……å¼¹çª—è¡¨å•
            document.getElementById('edit-prompt-id').value = problem.prompt_id;
            document.getElementById('edit-title').value = problem.title;
            document.getElementById('edit-question-text').value = problem.question_text;
            document.getElementById('edit-ai-prompt').value = problem.ai_prompt;
            document.getElementById('edit-image').value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥

            // æ˜¾ç¤ºå¼¹çª—
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }

        async function submitUpdate() {
            const promptId = document.getElementById('edit-prompt-id').value;
            const form = document.getElementById('editForm');
            const formData = new FormData();
            
            formData.append('title', document.getElementById('edit-title').value);
            formData.append('question_text', document.getElementById('edit-question-text').value);
            formData.append('ai_prompt', document.getElementById('edit-ai-prompt').value);
            
            const imageFile = document.getElementById('edit-image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            const response = await fetch(`/api/update-question/${promptId}`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (response.ok) {
                alert(result.message);
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                editModal.hide();
                fetchProblems(); // é‡æ–°åŠ è½½é—®é¢˜åˆ—è¡¨ä»¥æ˜¾ç¤ºæ›´æ–°
            } else {
                alert('Error: ' + result.message);
            }
        }
        async function deleteProblem(promptId) {
    const message = "Are you sure you want to delete this problem and all its responses? This action cannot be undone.";
    
    // æ˜¾ç¤ºä¸€ä¸ªç¡®è®¤å¯¹è¯æ¡†
    if (confirm(message)) {
        try {
            const response = await fetch(`/api/delete-question/${promptId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                fetchProblems(); // åˆ é™¤æˆåŠŸåï¼Œé‡æ–°åŠ è½½é—®é¢˜åˆ—è¡¨
            } else {
                throw new Error(result.message || 'Failed to delete the problem.');
            }
        } catch (error) {
            console.error('Deletion error:', error);
            alert('Error: ' + error.message);
        }
    }
}
const createForm = document.getElementById('create-question-form');
const createModal = new bootstrap.Modal(document.getElementById('createModal'));

createForm.addEventListener('submit', async function(event) {
    event.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤
    
    const formData = new FormData(createForm);
    const submitButton = document.querySelector('#createModal button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = 'Creating...';

    try {
        const response = await fetch('/api/create-question', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            alert('ğŸ‰ Question created successfully!');
            createModal.hide();   // å…³é—­å¼¹çª—
            createForm.reset();   // é‡ç½®è¡¨å•å†…å®¹
            fetchProblems();      // é‡æ–°åŠ è½½é—®é¢˜åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ–°åˆ›å»ºçš„é—®é¢˜
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Create error:', error);
        alert('An unexpected error occurred during creation.');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Create Question';
    }
});
    </script>
</body>
</html>